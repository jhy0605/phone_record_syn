{% extends "record_syn/base.html" %}

{% block content %}
    <div class="container">
        <h1 class="mb-4">文件同步统计概览</h1>

        <!-- 统计卡片区域 -->
        <div class="row">
            <!-- 总文件数卡片 -->
            <div class="col-md-4">
                <div class="card text-white bg-primary mb-3">
                    <div class="card-body">
                        <h5 class="card-title">本月总文件数</h5>
                        <p class="card-text fs-3">
                            {{ monthly_total|default:0 }}
                        </p>
                    </div>
                </div>
            </div>

            <!-- 今日文件数卡片 -->
            <div class="col-md-4">
                <div class="card text-white bg-success mb-3">
                    <div class="card-body">
                        <h5 class="card-title">今日文件数</h5>
                        <p class="card-text fs-3">
                            {{ today_total|default:0 }}
                        </p>
                    </div>
                </div>
            </div>

            <!-- 设备数卡片 -->
            <div class="col-md-4">
                <div class="card text-white bg-info mb-3">
                    <div class="card-body">
                        <h5 class="card-title">活跃设备数</h5>
                        <p class="card-text fs-3">
                            {{ active_device_count|default:0 }}
                        </p>
                    </div>
                </div>
            </div>
        </div>


        <!-- 设备文件排名 -->
        <div class="card mb-4">
            <div class="card-header">设备文件数量排名</div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th>排名</th>
                            <th>设备IP</th>
                            <th>部门</th>
                            <th>文件数量</th>
                            <th>最后同步时间</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for device in device_ranking %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ device.ip_address }}</td>
                                <td>{{ device.department }}</td>
                                <td>{{ device.total_files|default:0 }}</td>
                                <td>{{ device.last_sync_time|date:"Y-m-d H:i"|default:"从未同步" }}</td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="5" class="text-center">暂无数据</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 设备状态分布和同步记录（4:6布局） -->
        <div class="row">
            <div class="col-md-4">
                <div class="card mb-4" style="height: 450px;">  <!-- 固定高度 -->
                    <div class="card-header">设备状态分布</div>
                    <div class="card-body d-flex flex-column p-2" style="height: calc(100% - 40px);">
                        <!-- 减去header高度 -->
                        <div style="flex: 1; position: relative;"
                             class="d-flex justify-content-center align-items-center">  <!-- 图表容器，居中 -->
                            <canvas id="deviceStatusChart"
                                    style="width: 100%; max-width: 300px; height: auto;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card mb-4" style="height: 450px;">  <!-- 与左侧相同高度 -->
                    <div class="card-header">最近同步记录</div>
                    <div class="card-body p-0" style="height: calc(100% - 40px);">  <!-- 减去header高度 -->
                        <div class="table-responsive h-100">  <!-- 高度100% -->
                            <table class="table table-sm table-hover mb-0">
                                <thead class="sticky-top bg-light">
                                <tr>
                                    <th class="ps-3" width="220">时间</th>
                                    <th class="px-3" width="220">设备IP</th>
                                    <th class="px-3">部门</th>
                                    <th class="pe-3">文件数</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for record in recent_sync_records %}
                                    <tr>
                                        <td class="ps-3">{{ record.start_time|date:"Y-m-d H:i" }}</td>
                                        <td class="px-3">{{ record.device.ip_address }}</td>
                                        <td class="px-3">{{ record.device.department }}</td>
                                        <td class="pe-3">{{ record.file_count }}</td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center py-3">暂无同步记录</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 文件同步趋势图 -->
        <!-- 文件同步趋势图 -->
        <div class="card mb-4">
            <div class="card-header">
                近30天文件同步趋势 ({{ start_date|date:"Y-m-d" }} 至 {{ end_date|date:"Y-m-d" }})
            </div>
            <div class="card-body" style="position: relative; height: 300px;">  <!-- 增加高度到300px -->
                <canvas id="fileChart"></canvas>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // 文件同步趋势图
        const fileCtx = document.getElementById('fileChart').getContext('2d');
        const fileChart = new Chart(fileCtx, {
            type: 'line',
            data: {
                labels: [
                    {% for stat in daily_stats %}
                        "{{ stat.date|date:'m-d' }}"{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                datasets: [{
                    label: '文件数量',
                    data: [
                        {% for stat in daily_stats %}
                            {{ stat.total_files|default:0 }}{% if not forloop.last %},{% endif %}
                        {% endfor %}
                    ],
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,  // 不保持纵横比
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '文件数量'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',  // 图例放在顶部
                    }
                },
                layout: {
                    padding: {
                        top: 10,
                        right: 20,
                        bottom: 10,
                        left: 20
                    }
                }
            }
        });

        // 设备状态分布图（调整尺寸）
        const deviceStatusCtx = document.getElementById('deviceStatusChart').getContext('2d');
        const deviceStatusChart = new Chart(deviceStatusCtx, {
            type: 'doughnut',
            data: {
                labels: ['在线设备', '同步中', '离线设备'],
                datasets: [{
                    data: [
                        {{ online_devices }},
                        {{ syncing_devices }},
                        {{ offline_devices }}
                    ],
                    backgroundColor: [
                        'rgb(75, 192, 192)',  // online
                        'rgb(54, 162, 235)',  // syncing
                        'rgb(255, 99, 132)'   // offline
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        align: 'start',  // 图例顶部对齐
                        labels: {
                            boxWidth: 12,
                            padding: 20
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const total = {{ online_devices }} +{{ syncing_devices }} + {{ offline_devices }};
                                const percentage = (context.raw / total * 100).toFixed(1);
                                return `${context.label}: ${context.raw}台 (${percentage}%)`;
                            }
                        }
                    }
                },
                layout: {
                    padding: {
                        top: 20,
                        right: 20
                    }
                }
            }
        });
    </script>
{% endblock %}
