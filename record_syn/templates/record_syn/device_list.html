{% extends "record_syn/base.html" %}

{% block content %}
    <div class="container">
        <h2>设备列表</h2>
        <div class="d-flex justify-content-between align-items-center mb-4">
            <a href="{% url 'add_device' %}" class="btn btn-success">+ 添加设备</a>
            <!-- 搜索表单 -->
            <form class="ms-auto" style="max-width: 500px;">
                <div class="input-group">
                    <input type="text" name="q" class="form-control" placeholder="搜索IP/部门/备注"
                           value="{{ request.GET.q }}">
                    <select name="status" class="form-select" style="max-width: 150px;">
                        <option value="">全部状态</option>
                        {% for value, label in status_choices %}
                            <option value="{{ value }}"
                                    {% if request.GET.status == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-primary">搜索</button>
                </div>
            </form>
        </div>

        <!-- 设备表格 -->
        <table class="table table-striped">
            <thead>
            <tr>
                <th>IP地址</th>
                <th>部门</th>
                <th>状态</th>
                <th>最后备份时间</th>
                <th>备注</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            {% for device in page_obj %}
                <tr>
                    <td>{{ device.ip_address }}</td>
                    <td>{{ device.department }}</td>
                    <td>
                        <span class="badge
                            {% if device.status == 'online' %}bg-success
                            {% elif device.status == 'syncing' %}bg-primary
                            {% else %}bg-danger{% endif %}">
                            {{ device.get_status_display }}
                        </span>
                    </td>
                    <td>{{ device.last_sync_time|default:"从未同步" }}</td>
                    <td>{{ device.remarks|default:"-"|truncatechars:15 }}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary reconnect-btn"
                                    data-device-id="{{ device.id }}"
                                    {% if device.status == 'online' or device.status == 'syncing' %}disabled{% endif %}>
                                重新连接
                            </button>
                            <a href="{% url 'edit_device' device.id %}" class="btn btn-outline-secondary">编辑</a>
                            <button class="btn btn-outline-success sync-btn"
                                    data-device-id="{{ device.id }}"
                                    {% if device.status == 'offline' or device.status == 'syncing' %}disabled{% endif %}>
                                立即同步
                            </button>
                            <button class="btn btn-outline-danger delete-btn"
                                    data-device-id="{{ device.id }}"
                                    data-device-ip="{{ device.ip_address }}"
                                    data-bs-toggle="modal"
                                    data-bs-target="#deleteModal">
                                删除
                            </button>
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>

        <!-- 删除确认模态框 -->
        <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">确认删除设备</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>确定要删除设备 <strong id="deviceIpDisplay"></strong> 吗？此操作不可恢复！</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">确认删除</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 分页导航 -->
        <div class="pagination">
        <span class="step-links">
            {% if page_obj.has_previous %}
                <a href="?page=1{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">&laquo; 第一页</a>
                <a href="?page=









                        {{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">上一页</a>
            {% endif %}

            <span class="current">
                第 {{ page_obj.number }} 页，共 {{ page_obj.paginator.num_pages }} 页
            </span>

            {% if page_obj.has_next %}
                <a href="?page=









                        {{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">下一页</a>
                <a href="?page=









                        {{ page_obj.paginator.num_pages }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">最后一页 &raquo;</a>
            {% endif %}

            <span class="current ms-3">
                共 {{ page_obj.paginator.count }} 条记录
            </span>
        </span>
        </div>
    </div>

    <!-- 添加jQuery库 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- 添加Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>    // 等待DOM和jQuery加载完成
    document.addEventListener('DOMContentLoaded', function () {
        // 初始化删除模态框
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        let currentDeviceId = null;

        // 删除按钮点击事件
        $('.delete-btn').click(function () {
            currentDeviceId = $(this).data('device-id');
            const deviceIp = $(this).data('device-ip');
            $('#deviceIpDisplay').text(deviceIp);
        });

        // 确认删除按钮事件
        $('#confirmDeleteBtn').click(function () {
            const btn = $(this);
            btn.prop('disabled', true)
                .html('<span class="spinner-border spinner-border-sm"></span> 删除中...');

            $.ajax({
                url: '/account/devices/' + currentDeviceId + '/delete/',
                method: 'POST',
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function (response) {
                    if (response.status === 'success') {
                        deleteModal.hide();
                        location.reload();
                    } else {
                        alert('删除失败: ' + (response.message || '未知错误'));
                        btn.prop('disabled', false).text('确认删除');
                    }
                },
                error: function (xhr) {
                    alert('删除失败: ' + (xhr.responseJSON?.message || xhr.statusText));
                    btn.prop('disabled', false).text('确认删除');
                }
            });
        });

        // 重新连接按钮
        $('.reconnect-btn').click(function () {
            const btn = $(this);
            btn.prop('disabled', true)
                .html('<span class="spinner-border spinner-border-sm"></span> 连接中...');

            $.ajax({
                url: '/account/api/devices/' + $(this).data('device-id') + '/reconnect/',
                method: 'POST',
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function () {
                    location.reload();
                },
                error: function (xhr) {
                    alert('连接失败: ' + (xhr.responseJSON?.message || xhr.statusText));
                    btn.prop('disabled', false).text('重新连接');
                }
            });
        });

        // 立即同步按钮
        $('.sync-btn').click(function () {
            const btn = $(this);
            const deviceId = btn.data('device-id');

            // 禁用按钮
            btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> 同步中...');

            // 发送同步请求
            $.ajax({
                url: `/account/api/devices/${deviceId}/sync/`,
                method: 'POST',
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}'  // 必须包含CSRF token
                },
                success: function () {
                    // 同步完成后刷新页面
                    location.reload();
                },
                error: function (xhr) {
                    // 恢复按钮状态
                    btn.prop('disabled', false).text('立即同步');
                    alert('同步失败: ' + (xhr.responseJSON?.message || xhr.statusText));
                }
            });
        });
    });
    </script>

{% endblock %}
